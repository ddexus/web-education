<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Профиль администратора</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>

<div id="page-loader">
  <div class="loader"></div>
</div>

<main class="admin-page">
  <div class="profile-card">
    <div class="card-header">
      <h1>Профиль администратора</h1>
    </div>

    <div class="card-content">
      <!-- Создание ученика -->
<h2>Создать нового ученика</h2>
<button type="button" class="toggle-form-btn" 
        onclick="document.getElementById('createPupilForm').style.display = 
                 document.getElementById('createPupilForm').style.display === 'block' ? 'none' : 'block'">
  Показать / Скрыть форму ученика
</button>

<form id="createPupilForm" style="display: none;">
  <label>Логин:</label><input type="text" id="pLogin" required>
  <label>Пароль:</label><input type="password" id="pPassword" required>
  <label>Имя:</label><input type="text" id="pName" required>
  <label>Фамилия:</label><input type="text" id="pSurname" required>
  <label>Возраст:</label><input type="number" id="pAge" required>
  <label>Группа:</label><input type="number" id="pGroup" required>
  <label>Баллы:</label><input type="number" id="pPoints" value="0">
  <label>Невыполненные ДЗ:</label><input type="number" id="pNotdone" value="0">
  <button type="submit">Создать ученика</button>
</form>

<!-- Создание учителя -->
<h2>Создать нового учителя</h2>
<button type="button" class="toggle-form-btn" 
        onclick="document.getElementById('createTeacherForm').style.display = 
                 document.getElementById('createTeacherForm').style.display === 'block' ? 'none' : 'block'">
  Показать / Скрыть форму учителя
</button>

<form id="createTeacherForm" style="display: none;">
  <label>Логин:</label><input type="text" id="tLogin" required>
  <label>Пароль:</label><input type="password" id="tPassword" required>
  <label>Имя:</label><input type="text" id="tName" required>
  <label>Фамилия:</label><input type="text" id="tSurname" required>
  <label>Группа:</label><input type="number" id="tGroup" required>
  <button type="submit">Создать учителя</button>
</form>
      <!-- Таблица учеников -->
      <h2>Все ученики</h2>
      <div class="table-wrapper">
        <table id="pupilsTable" border="1">
          <thead>
            <tr>
              <th>Группа</th>
              <th>Фамилия</th>
              <th>Имя</th>
              <th>Возраст</th>
              <th>Баллы</th>
              <th>Невыполненные ДЗ</th>
              <th>Логин</th>
              <th>Пароль</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Таблица учителей -->
      <h2>Все учителя</h2>
      <div class="table-wrapper">
        <table id="teachersTable" border="1">
          <thead>
            <tr>
              <th>Группа</th>
              <th>Фамилия</th>
              <th>Имя</th>
              <th>Логин</th>
              <th>Пароль</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card-footer">
      <button id="logout">Выйти</button>
    </div>
  </div>
</main>

<script src="./cookies.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  updateDoc,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAobCt_Y_6xu2k1WVdJp_uGE7RyByGo0cQ",
  authDomain: "web-education-10d3e.firebaseapp.com",
  projectId: "web-education-10d3e",
  storageBucket: "web-education-10d3e.firebasestorage.app",
  messagingSenderId: "794388783858",
  appId: "1:794388783858:web:98f84ec7f05583fdb5266b",
  measurementId: "G-HFFQ7NEX8M"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ────────────────────────────────────────────────
//  Скрытие лоадера
// ────────────────────────────────────────────────
function hideLoader() {
  const loader = document.getElementById('page-loader');
  if (loader) loader.classList.add('hidden');
}

// ────────────────────────────────────────────────
//  Проверка авторизации
// ────────────────────────────────────────────────
const role = getCookie('role');
const userId = getCookie('userId');

if (role !== 'admin' || !userId) {
  window.location.href = 'index.html';
}

// ────────────────────────────────────────────────
//  Загрузка и обновление таблиц
// ────────────────────────────────────────────────
async function loadTables() {
  try {
    // Ученики
    const pupilsSnap = await getDocs(collection(db, 'pupils'));
    const pupils = pupilsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    pupils.sort((a, b) => a.group - b.group || a.surname.localeCompare(b.surname));

    const pupilsTbody = document.querySelector('#pupilsTable tbody');
    pupilsTbody.innerHTML = '';

    pupils.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true" data-field="group"     data-id="${p.id}">${p.group ?? ''}</td>
        <td contenteditable="true" data-field="surname"   data-id="${p.id}">${p.surname ?? ''}</td>
        <td contenteditable="true" data-field="name"      data-id="${p.id}">${p.name ?? ''}</td>
        <td contenteditable="true" data-field="age"       data-id="${p.id}">${p.age ?? ''}</td>
        <td contenteditable="true" data-field="points"    data-id="${p.id}">${p.points ?? 0}</td>
        <td contenteditable="true" data-field="notdonehws" data-id="${p.id}">${p.notdonehws ?? 0}</td>
        <td contenteditable="true" data-field="login"     data-id="${p.id}">${p.login ?? ''}</td>
        <td contenteditable="true" data-field="password"  data-id="${p.id}">${p.password ?? ''}</td>
      `;
      pupilsTbody.appendChild(tr);
    });

    // Учителя
    const teachersSnap = await getDocs(collection(db, 'teachers'));
    const teachers = teachersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    teachers.sort((a, b) => a.group - b.group || a.surname.localeCompare(b.surname));

    const teachersTbody = document.querySelector('#teachersTable tbody');
    teachersTbody.innerHTML = '';

    teachers.forEach(t => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true" data-field="group"    data-id="${t.id}">${t.group ?? ''}</td>
        <td contenteditable="true" data-field="surname"  data-id="${t.id}">${t.surname ?? ''}</td>
        <td contenteditable="true" data-field="name"     data-id="${t.id}">${t.name ?? ''}</td>
        <td contenteditable="true" data-field="login"    data-id="${t.id}">${t.login ?? ''}</td>
        <td contenteditable="true" data-field="password" data-id="${t.id}">${t.password ?? ''}</td>
      `;
      teachersTbody.appendChild(tr);
    });

  } catch (error) {
    console.error("Ошибка загрузки таблиц:", error);
  }
}

// ────────────────────────────────────────────────
//  Сохранение изменений в таблицах при редактировании
// ────────────────────────────────────────────────
document.body.addEventListener('blur', async (e) => {
  if (e.target.contentEditable === 'true') {
    const field = e.target.dataset.field;
    const id = e.target.dataset.id;
    let value = e.target.textContent.trim();

    const table = e.target.closest('table');
    const collectionName = table.id === 'pupilsTable' ? 'pupils' : 'teachers';

    if (['age', 'points', 'notdonehws', 'group'].includes(field)) {
      value = parseInt(value) || 0;
    }

    try {
      await updateDoc(doc(db, collectionName, id), { [field]: value });
    } catch (error) {
      console.error("Ошибка обновления поля:", error);
    }
  }
}, true);

// ────────────────────────────────────────────────
//  Создание нового ученика
// ────────────────────────────────────────────────
document.getElementById('createPupilForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const data = {
    login: document.getElementById('pLogin').value.trim(),
    password: document.getElementById('pPassword').value.trim(),
    name: document.getElementById('pName').value.trim(),
    surname: document.getElementById('pSurname').value.trim(),
    age: parseInt(document.getElementById('pAge').value) || 0,
    group: parseInt(document.getElementById('pGroup').value) || 0,
    points: parseInt(document.getElementById('pPoints').value) || 0,
    notdonehws: parseInt(document.getElementById('pNotdone').value) || 0
  };

  try {
    const newId = doc(collection(db, 'pupils')).id;
    await setDoc(doc(db, 'pupils', newId), data);
    alert('Ученик успешно создан');
    e.target.reset();
    await loadTables();
  } catch (error) {
    console.error("Ошибка создания ученика:", error);
    alert('Не удалось создать ученика');
  }
});

// ────────────────────────────────────────────────
//  Создание нового учителя
// ────────────────────────────────────────────────
document.getElementById('createTeacherForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const data = {
    login: document.getElementById('tLogin').value.trim(),
    password: document.getElementById('tPassword').value.trim(),
    name: document.getElementById('tName').value.trim(),
    surname: document.getElementById('tSurname').value.trim(),
    group: parseInt(document.getElementById('tGroup').value) || 0
  };

  try {
    const newId = doc(collection(db, 'teachers')).id;
    await setDoc(doc(db, 'teachers', newId), data);
    alert('Учитель успешно создан');
    e.target.reset();
    await loadTables();
  } catch (error) {
    console.error("Ошибка создания учителя:", error);
    alert('Не удалось создать учителя');
  }
});

// ────────────────────────────────────────────────
//  Инициализация
// ────────────────────────────────────────────────
(async () => {
  await loadTables();
  hideLoader();
})();

// Выход из системы
document.getElementById('logout').addEventListener('click', () => {
  deleteCookie('role');
  deleteCookie('userId');
  window.location.href = './index.html';
});
</script>

</body>
</html>