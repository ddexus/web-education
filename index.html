<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Вход в аккаунт</title>
    <link rel="stylesheet" href="./style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="page-loader">
        <div class="loader"></div>
    </div>

    <main class="login-page">
      <div class="login-card">
        <h1>Вход</h1>
        <form id="loginForm">
          <label for="login">Логин:</label>
          <input type="text" id="login" required>

          <label for="password">Пароль:</label>
          <input type="password" id="password" required>

          <button type="submit">Войти</button>
        </form>
      </div>
    </main>

    <script src="cookies.js"></script>
    <script src="./cookies.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAobCt_Y_6xu2k1WVdJp_uGE7RyByGo0cQ",
        authDomain: "web-education-10d3e.firebaseapp.com",
        projectId: "web-education-10d3e",
        storageBucket: "web-education-10d3e.firebasestorage.app",
        messagingSenderId: "794388783858",
        appId: "1:794388783858:web:98f84ec7f05583fdb5266b",
        measurementId: "G-HFFQ7NEX8M"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Проверка, если уже авторизован
      const role = getCookie('role');
      const userId = getCookie('userId');

      if (role && userId) {
        if (role === 'admin') window.location.href = './admin.html';
        else if (role === 'teacher') window.location.href = './teacher.html';
        else if (role === 'pupil') window.location.href = './pupil.html';
      }

      const form = document.getElementById('loginForm');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value.trim();

        // Проверка админов
        let q = query(collection(db, 'admins'), where('login', '==', login));
        let snapshot = await getDocs(q);

        if (!snapshot.empty) {
          const docSnap = snapshot.docs[0];
          if (docSnap.data().password === password) {
            setCookie('role', 'admin', 30 * 24 * 60 * 60);
            setCookie('userId', docSnap.id, 30 * 24 * 60 * 60);
            window.location.href = './admin.html';
            return;
          }
        }

        // Проверка учителей
        q = query(collection(db, 'teachers'), where('login', '==', login));
        snapshot = await getDocs(q);

        if (!snapshot.empty) {
          const docSnap = snapshot.docs[0];
          if (docSnap.data().password === password) {
            setCookie('role', 'teacher', 30 * 24 * 60 * 60);
            setCookie('userId', docSnap.id, 30 * 24 * 60 * 60);
            window.location.href = './teacher.html';
            return;
          }
        }

        // Проверка учеников
        q = query(collection(db, 'pupils'), where('login', '==', login));
        snapshot = await getDocs(q);

        if (!snapshot.empty) {
          const docSnap = snapshot.docs[0];
          if (docSnap.data().password === password) {
            setCookie('role', 'pupil', 30 * 24 * 60 * 60);
            setCookie('userId', docSnap.id, 30 * 24 * 60 * 60);
            window.location.href = './pupil.html';
            return;
          }
        }

        alert('Неверный логин или пароль');
      });
    </script>
</body>
</html>